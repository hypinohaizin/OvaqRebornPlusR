package net.shoreline.client.impl.module.exploit;

import net.minecraft.item.ItemStack;
import net.minecraft.item.Items;
import net.shoreline.client.api.config.Config;
import net.shoreline.client.api.config.setting.BooleanConfig;
import net.shoreline.client.api.config.setting.NumberConfig;
import net.shoreline.client.api.module.ModuleCategory;
import net.shoreline.client.api.module.ToggleModule;
import net.shoreline.client.impl.event.TickEvent;
import net.shoreline.client.impl.event.item.FinishUsingEvent;
import net.shoreline.client.impl.event.network.GameJoinEvent;
import net.shoreline.client.impl.module.combat.*;
import net.shoreline.client.impl.module.world.AutoMineModule;
import net.shoreline.client.init.Managers;
import net.shoreline.client.util.math.timer.CacheTimer;
import net.shoreline.client.util.math.timer.Timer;
import net.shoreline.client.util.player.InventoryUtil;
import net.shoreline.client.util.player.PlayerUtil;
import net.shoreline.eventbus.annotation.EventListener;
import net.shoreline.eventbus.event.StageEvent;

public class ChorusInvincibilityModule extends ToggleModule
{
    private static ChorusInvincibilityModule INSTANCE;

    Config<Boolean> healthCheckConfig = register(new BooleanConfig("CheckHealth", "Checks health when joining game", false));
    Config<Float> healthConfig = register(new NumberConfig<>("Health", "The health to use chorus", 1.0f, 20.0f, 20.0f, () -> healthCheckConfig.getValue()));
    Config<Boolean> totemsCheckConfig = register(new BooleanConfig("CheckTotems", "Checks totems when joining game", false));
    Config<Integer> totemsConfig = register(new NumberConfig<>("Totems", "The totems to use chorus", 0, 0, 5, () -> totemsCheckConfig.getValue()));
    private boolean useChorus;
    private final Timer invincibilityTimer = new CacheTimer();

    public ChorusInvincibilityModule()
    {
        super("ChorusInvincibility", "Automatically uses chorus during invincibility frames", ModuleCategory.EXPLOITS);
        INSTANCE = this;
    }

    public static ChorusInvincibilityModule getInstance()
    {
        return INSTANCE;
    }

    @Override
    public void onDisable()
    {
        useChorus = false;
        mc.options.useKey.setPressed(false);
    }

    @EventListener
    public void onGameJoin(GameJoinEvent event)
    {
        if (checkChorus())
        {
            useChorus = true;
            invincibilityTimer.reset();

            // Disable all pvp modules
            AutoAnchorModule.getInstance().disable();
            AutoCrystalModule.getInstance().disable();
            AutoTrapModule.getInstance().disable();
            AutoCrawlTrapModule.getInstance().disable();
            AutoXPModule.getInstance().disable();
            HoleFillModule.getInstance().disable();
            SelfTrapModule.getInstance().disable();
            SurroundModule.getInstance().disable();
            AutoMineModule.getInstance().disable();
        }
    }

    @EventListener
    public void onTick(TickEvent event)
    {
        if (event.getStage() != StageEvent.EventStage.POST || !useChorus || invincibilityTimer.passed(5000))
        {
            return;
        }
        int slot = -1;
        for (int i = 0; i < 9; i++)
        {
            ItemStack stack1 = mc.player.getInventory().getStack(i);
            if (stack1.getItem() == Items.CHORUS_FRUIT)
            {
                slot = i;
            }
        }
        if (slot == -1)
        {
            return;
        }
        Managers.INVENTORY.setClientSlot(slot);
        mc.options.useKey.setPressed(true);
    }

    @EventListener
    public void onFinishUsing(FinishUsingEvent event)
    {
        if (useChorus && event.getStack().getItem() == Items.CHORUS_FRUIT)
        {
            disable();
        }
    }

    private boolean checkChorus()
    {
        if (healthCheckConfig.getValue() && PlayerUtil.getLocalPlayerHealth() > healthConfig.getValue())
        {
            return false;
        }
        return !totemsCheckConfig.getValue() || InventoryUtil.count(Items.TOTEM_OF_UNDYING) <= totemsConfig.getValue();
    }

    public boolean isUsingChorus()
    {
        return useChorus;
    }
}