package net.shoreline.client.impl.module.exploit;

import net.minecraft.entity.Entity;
import net.minecraft.entity.player.PlayerEntity;
import net.minecraft.network.packet.c2s.play.PlayerMoveC2SPacket;
import net.minecraft.util.math.Vec3d;
import net.shoreline.client.OvaqRebornPlus;
import net.shoreline.client.api.module.ModuleCategory;
import net.shoreline.client.api.module.ToggleModule;
import net.shoreline.client.impl.event.TickEvent;
import net.shoreline.client.init.Managers;
import net.shoreline.eventbus.annotation.EventListener;

public class PlayerTPModule extends ToggleModule
{
    public PlayerTPModule()
    {
        super("PlayerTP", "Teleports you to the nearest player", ModuleCategory.EXPLOITS);
    }

    @EventListener
    public void onTick(TickEvent event)
    {
        if (mc.world == null || mc.player == null) return;

        PlayerEntity closest = null;
        double d = Double.MAX_VALUE;

        for (Entity entity : mc.world.getEntities())
        {
            if (entity instanceof PlayerEntity player && player != mc.player)
            {
                double dist = mc.player.distanceTo(player);
                if (dist < d)
                {
                    closest = player;
                    d = dist;
                }
            }
        }

        if (closest != null)
        {
            Vec3d from = mc.player.getPos();
            Vec3d to = closest.getPos();
            double td = Math.ceil(from.distanceTo(to) / 8.5);

            for (int i = 1; i <= td; i++)
            {
                Vec3d curPos = from.lerp(to, i / td);
                Managers.NETWORK.sendPacket(new PlayerMoveC2SPacket.PositionAndOnGround(
                        curPos.x, curPos.y, curPos.z, mc.player.isOnGround()));
                mc.player.setPosition(curPos);
            }

            OvaqRebornPlus.info("Teleported to player {}", closest.getGameProfile().getName());
        }
    }
}